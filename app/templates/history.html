{% extends "base.html" %}

{% block title %}History - SafeSight Dashboard{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="/static/css/history.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="history-wrapper">
    <!-- Animated Background -->
    <div class="bg-decoration">
        <div class="bg-gradient-1"></div>
        <div class="bg-gradient-2"></div>
    </div>

    <div class="history-container">
        <!-- Hero Header -->
        <div class="history-hero">
            <div class="hero-content">
                <div class="hero-badge">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M8 0L9.79611 5.52786H15.6085L10.9062 8.94427L12.7023 14.4721L8 11.0557L3.29772 14.4721L5.09383 8.94427L0.391548 5.52786H6.20389L8 0Z" fill="currentColor"/>
                    </svg>
                    <span>Security Intelligence</span>
                </div>
                <h1 class="hero-title">Event History</h1>
                <p class="hero-description">
                    Comprehensive audit trail of all security events, anomalies, and system activities. Track, analyze, and respond to incidents with precision.
                </p>
                
                {% if current_user.role == 'admin' %}
                <div class="hero-actions">
                    <a class="btn-primary" href="/history/add">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M10 4V16M4 10H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <span>Add New Anomaly</span>
                    </a>
                    <button class="btn-secondary">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M4 12L8 16L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Export Report</span>
                    </button>
                </div>
                {% endif %}
            </div>
            
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card stat-card-primary">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="total-anomalies">0</div>
                        <div class="stat-label">Total Anomalies</div>
                    </div>
                </div>
                
                <div class="stat-card stat-card-danger">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 8V12L14.5 14.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="active-alerts">0</div>
                        <div class="stat-label">Active Alerts</div>
                    </div>
                </div>
                
                <div class="stat-card stat-card-success">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="resolved-count">0</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="tab-list">
                <button id="anomalyTab" class="tab-item active" data-tab="anomaly">
                    <div class="tab-icon">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M10 2L12.5 7L18 8L14 12L15 18L10 15L5 18L6 12L2 8L7.5 7L10 2Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <span>Anomaly History</span>
                    <div class="tab-badge" id="anomaly-count">0</div>
                </button>
                
                <button id="alarmTab" class="tab-item" data-tab="alarm">
                    <div class="tab-icon">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M10 3C9 3 8 3.5 7 4.5C6 5.5 5 7 5 9C5 11 4 12 2 12M10 3C11 3 12 3.5 13 4.5C14 5.5 15 7 15 9C15 11 16 12 18 12M10 3V2M8 17H12M10 20C8.89543 20 8 19.1046 8 18V17H12V18C12 19.1046 11.1046 20 10 20Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span>Alarm History</span>
                    <div class="tab-badge" id="alarm-count">0</div>
                </button>
            </div>
            
            <div class="search-filter">
                <div class="search-box">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <path d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M16 16L12.65 12.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <input type="text" placeholder="Search events..." />
                </div>
            </div>
        </div>

        <!-- Table Content -->
        <div class="table-wrapper">
            <div id="anomaly-history" class="history-table"></div>
            <div id="anomaly-pagination" class="pagination"></div>

            <div id="alarm-history" class="history-table" style="display: none"></div>
            <div id="alarm-pagination" class="pagination" style="display: none"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
var anomalies = {{ anomalies | tojson }};
var alarmHistory = {{ alarm_history | tojson }};

// Update stats
document.getElementById('total-anomalies').textContent = anomalies.length;
document.getElementById('anomaly-count').textContent = anomalies.length;
document.getElementById('alarm-count').textContent = alarmHistory.length;

var activeCount = anomalies.filter(a => a.status && a.status.toLowerCase().includes('active')).length;
var resolvedCount = anomalies.filter(a => a.status && a.status.toLowerCase().includes('resolved')).length;
document.getElementById('active-alerts').textContent = activeCount;
document.getElementById('resolved-count').textContent = resolvedCount;

function createPaginatedTable(data, columns, containerId, paginationId, itemsPerPage = 50) {
    const container = document.getElementById(containerId);
    const paginationContainer = document.getElementById(paginationId);
    let currentPage = 1;

    function renderTable(pageData) {
        container.innerHTML = '';
        
        if (pageData.length === 0) {
            container.innerHTML = '<div class="empty-state"><svg width="64" height="64" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="30" stroke="currentColor" stroke-width="2"/><path d="M32 20V32L40 40" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><p>No events found</p></div>';
            return;
        }
        
        var table = document.createElement("table");
        table.className = "history-table-content";

        var thead = document.createElement("thead");
        var headerRow = document.createElement("tr");
        var th = document.createElement("th");
        th.innerText = "#";
        th.className = "col-serial";
        headerRow.appendChild(th);
        
        columns.forEach(function(col) {
            var th = document.createElement("th");
            th.innerText = col.header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        var tbody = document.createElement("tbody");
        pageData.forEach(function(item, index) {
            var row = document.createElement("tr");
            row.className = "table-row";
            
            var serialCell = document.createElement("td");
            serialCell.innerText = ((currentPage - 1) * itemsPerPage) + index + 1;
            serialCell.className = "col-serial";
            row.appendChild(serialCell);
            
            columns.forEach(function(col) {
                var td = document.createElement("td");
                var value = item[col.field] || "";
                
                // Add badges for status
                if (col.field === 'status' && value) {
                    var badge = document.createElement("span");
                    badge.className = "status-badge status-" + value.toLowerCase().replace(/\s/g, '-');
                    badge.innerText = value;
                    td.appendChild(badge);
                } else if (col.field === 'confidence' && value) {
                    var confidenceBar = document.createElement("div");
                    confidenceBar.className = "confidence-bar";
                    var confidenceFill = document.createElement("div");
                    confidenceFill.className = "confidence-fill";
                    confidenceFill.style.width = value;
                    confidenceBar.appendChild(confidenceFill);
                    var confidenceText = document.createElement("span");
                    confidenceText.className = "confidence-text";
                    confidenceText.innerText = value;
                    td.appendChild(confidenceBar);
                    td.appendChild(confidenceText);
                } else {
                    td.innerText = value;
                }
                
                row.appendChild(td);
            });
            tbody.appendChild(row);
        });
        table.appendChild(tbody);
        container.appendChild(table);
        
        // Animate rows
        setTimeout(() => {
            document.querySelectorAll('.table-row').forEach((row, idx) => {
                setTimeout(() => {
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, idx * 30);
            });
        }, 10);
    }

    function renderPagination() {
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(data.length / itemsPerPage);
        
        if (totalPages <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';

        const prevButton = document.createElement('button');
        prevButton.className = 'pagination-btn';
        prevButton.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Previous</span>';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateView();
            }
        });
        paginationContainer.appendChild(prevButton);

        const pageInfo = document.createElement('div');
        pageInfo.className = 'page-info';
        pageInfo.innerHTML = `<span class="page-current">${currentPage}</span><span class="page-separator">/</span><span class="page-total">${totalPages}</span>`;
        paginationContainer.appendChild(pageInfo);

        const nextButton = document.createElement('button');
        nextButton.className = 'pagination-btn';
        nextButton.innerHTML = '<span>Next</span><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        nextButton.disabled = currentPage === totalPages;
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                updateView();
            }
        });
        paginationContainer.appendChild(nextButton);
    }

    function updateView() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = data.slice(startIndex, endIndex);
        
        renderTable(pageData);
        renderPagination();
    }

    updateView();

    return {
        updateData: function(newData) {
            data = newData;
            currentPage = 1;
            updateView();
        }
    };
}

var anomalyColumns = [
    {header: "Location", field: "location"},
    {header: "Camera ID", field: "camera_id"},
    {header: "IP Address", field: "ipaddress"},
    {header: "Anomaly Code", field: "anomaly_code"},
    {header: "Anomaly Name", field: "anomaly_name"},
    {header: "Timestamp", field: "timestamp"},
    {header: "Duration", field: "duration"},
    {header: "Confidence", field: "confidence"},
    {header: "Status", field: "status"},
    {header: "Actions Taken", field: "actions_taken"},
    {header: "Video Path", field: "videopath"}
];

var alarmColumns = [
    {header: "Room", field: "room"},
    {header: "Location", field: "location"},
    {header: "Activated By", field: "activated_by"},
    {header: "Start Time", field: "start_time"},
    {header: "End Time", field: "end_time"},
    {header: "Duration", field: "duration"}
];

var anomalyTable = createPaginatedTable(anomalies, anomalyColumns, "anomaly-history", "anomaly-pagination");
var alarmTable = createPaginatedTable(alarmHistory, alarmColumns, "alarm-history", "alarm-pagination");

document.getElementById("anomalyTab").addEventListener("click", function() {
    document.getElementById("anomaly-history").style.display = "block";
    document.getElementById("anomaly-pagination").style.display = "flex";
    document.getElementById("alarm-history").style.display = "none";
    document.getElementById("alarm-pagination").style.display = "none";
    this.classList.add("active");
    document.getElementById("alarmTab").classList.remove("active");
});

document.getElementById("alarmTab").addEventListener("click", function() {
    document.getElementById("anomaly-history").style.display = "none";
    document.getElementById("anomaly-pagination").style.display = "none";
    document.getElementById("alarm-history").style.display = "block";
    document.getElementById("alarm-pagination").style.display = "flex";
    this.classList.add("active");
    document.getElementById("anomalyTab").classList.remove("active");
});
</script>
{% endblock %}